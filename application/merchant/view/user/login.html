<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:lang('登入')}</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="{$laypath}/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="{$laypath}/style/admin.css" media="all">
    <link rel="stylesheet" href="{$laypath}/style/login.css" media="all">
</head>
<body>
<div class="layadmin-user-login layadmin-user-display-show" id="LAY-user-login" style="display: none;">

    <div class="layadmin-user-login-main">
        <div class="layadmin-user-login-box layadmin-user-login-header">
            <h2>{:lang('渠道管理系统')}</h2>
            <p></p>
        </div>
        <div class="layadmin-user-login-box layadmin-user-login-body layui-form">
            <div class="layui-card">
                <div class="layui-card-body" style="padding-left:35px">
                            <ul class="layui-row layui-col-space30" >
                                <li class="layui-col-xs6 layui-inline ">
                                    <a href="{:url('user/index')}?lang=zh-cn">
                                        <img  src="__images__/flag_cn.png"  style="padding:5px;border:1px solid #ccc" />
                                    </a>
                                </li>
                                <li class="layui-col-xs6 layui-text-center">
                                    <a href="{:url('user/index')}?lang=en-us">
                                        <img  src="__images__/flag_en.png" style="padding:5px;border:1px solid #ccc"/>
                                    </a>
                                </li>
                                <!-- <li class="layui-col-xs4 layui-text-center">
                                    <a href="{:url('login/index')}?lang=thai">
                                        <img  src="__images__/flag_thai.png" style="padding:5px;border:1px solid #ccc" />
                                    </a>
                                </li> -->
                            </ul>
                        </div>
            </div>

            <div class="layui-form-item">
                <label class="layadmin-user-login-icon layui-icon layui-icon-username"
                       for="LAY-user-login-username"></label>
                <input type="text" name="username" id="LAY-user-login-username" lay-verify="required" placeholder="{:lang('用户名')}"
                       class="layui-input">
            </div>
            <div class="layui-form-item">
                <label class="layadmin-user-login-icon layui-icon layui-icon-password"
                       for="LAY-user-login-password"></label>
                <input type="password" name="password" id="LAY-user-login-password" lay-verify="required"
                       placeholder="{:lang('密码')}" class="layui-input">
            </div>
            <!--            <div class="layui-form-item">-->
            <!--                <label class="layadmin-user-login-icon layui-icon layui-icon-cellphone"-->
            <!--                       for="LAY-user-login-mobile"></label>-->
            <!--                <input type="text" name="mobile" id="LAY-user-login-mobile" lay-verify="required" placeholder="手机号"-->
            <!--                       class="layui-input">-->
            <!--            </div>-->
            <!--<div class="layui-form-item">-->
                <!--<input type="radio" name="choose" lay-filter="filter" id="sj" title="手机验证" value="1" checked>-->
                <!--<input type="radio" name="choose" lay-filter="filter" id="gg" title="谷歌验证" value="2">-->
            <!--</div>-->
            <div class="layui-form-item layui-hide" id="mobilecode">
                <div class="layui-row">

                    <label class="layadmin-user-login-icon layui-icon layui-icon-vercode"
                           for="code1"></label>
                    <input type="text" name="vercode1" id="code1" VALUE="1234"
                           placeholder="验证码" class="layui-input " style="width: 55%;float: left">
                    <button id="sendcode" class="layui-btn sendCode layui-hide"  style="width: 35%;float: right">{:lang('发送验证码')}</button>
                </div>
            </div>

            <div class="layui-form-item" id="codeimg" style="display: none;text-align: center">
                <img id="imgsrc" style="text-align:center;width: 100px;height: 100px"/>
            </div>

            <div class="layui-trans layui-form-item layadmin-user-login-other" id="secretpart" style="display: none">
                <ul>
                    <li>{:lang('您的谷歌验证秘钥为')}:<span id="secret" style="color: #FF5722;"></span></li>
                </ul>
            </div>

            <div class="layui-form-item" id="googlecode" >
                <div class="layui-row">

                    <label class="layadmin-user-login-icon layui-icon layui-icon-vercode"
                           for="code2"></label>
                    <input type="text" name="vercode2" id="code2"
                          placeholder="{:lang('验证码')}" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item" style="margin-bottom: 20px;">
                <input type="checkbox" name="remember" lay-skin="primary" title="{:lang('记住一周')}">
                <!--<a href="forget.html" class="layadmin-user-jump-change layadmin-link" style="margin-top: 7px;">忘记密码？</a>-->
            </div>
            <div class="layui-form-item">
                <button class="layui-btn layui-btn-fluid" lay-submit lay-filter="LAY-user-login-submit">{:lang('登入')}</button>
            </div>

            <div class="layui-trans layui-form-item layadmin-user-login-other">
                <ul>
                    <li style="color: #FF5722;">{:lang('谷歌验证需下载')}Google Authenticator APP。</li>
                    <li style="color: #FF5722;">{:lang('使用谷歌验证需先输入账号密码及手机号。')}</li>
                    <li style="color: #FF5722;">{:lang('首次使用谷歌验证务必先扫描二维码，已使用过的直接打开APP输入对应的验证码即可。')}</li>
                </ul>
            </div>
        </div>

    </div>


</div>

<script src="{$laypath}/layui/layui.js"></script>
<script src="__js__/jquery.min.js?v=2.1.4"></script>
<!--<script src="__js__/common.js?v=1.1"></script>-->
<script src="__js__/cache.js"></script>
<script src="__js__/Barrett.js"></script>
<script src="__js__/BigInt.js"></script>
<script src="__js__/RSA.js"></script>
<script>
    layui.config({
        base: '{$laypath}/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'user'], function () {
        var $ = layui.$
            , setter = layui.setter
            , admin = layui.admin
            , form = layui.form
            , router = layui.router()
            , search = router.search;

        var m = "	AF148DF38814A7CF2906B8CD2957F88D0F1F7F708A17371E408EE6629B25EC6B8514C3698F874B1C04E2EE7B05518FB58FE9EB57C0DC0617A7012E28D5D66D4B2F4B8676E28CB80DC0BA339740BAA557B872A5D6DD9E70E90C2943EDFB24A4597C252978E3556210E00CFB0BD2428FD77DE108A0BAF3BC8E06D71B3D65CECC6D";
        var n = 10001;

        form.render();

        //提交
        form.on('submit(LAY-user-login-submit)', function (obj) {


            var username = $('#LAY-user-login-username').val();
            var password = $('#LAY-user-login-password').val();
            var code = $('#code2').val();
            // var mobile = $('#LAY-user-login-mobile').val();
            // var choose = [];
            // $('input[name="choose"]:checked').each(function () {
            //     choose.push($(this).val());
            // });
            // choosecode = choose[0];
            // if (choosecode == 1) {
            //     var code = $('#code1').val();
            // } else {
            //
            // }

            var remember = [];
            $('input[name="remember"]:checked').each(function () {
                remember.push($(this).val());
            });
            var sr = 0;
            if (remember[0] === 'on') {
                sr = 1;
            }
            if (username == '' || password == '') {
                layer.msg("{:lang('账号密码不能为空')}", {offset: 't'});
                return;
            }
            // if (mobile == '') {
            //     layer.msg('手机号不能为空', {offset: 't'});
            //     return;
            // }
            if (code == '' || code == null) {
                layer.msg("{:lang('验证码不能为空')}", {offset: 't'});
                return;
            }

            // setMaxDigits(131);
            // var key = new RSAKeyPair("10001", '', m);
            // password = encryptedString(key, password);
            // console.log(password);

            $.ajax({
                type: 'post',
                url: "{:url('user/login')}",
                data: {
                    username: username,
                    password: password,
                    // mobile: mobile,
                    code: code,
                    //choose: choosecode,
                    remember: sr
                },
                dataType: 'json',
                success: function (res) {
                    if (res.code === 0) {
                        layer.msg("{:lang('登录成功')}", {icon: 1, time: 1000}, function () {
                            window.location.href = "{:url('merchant/index/index')}?lang={$currlang}";
                        });
                    } else if (res.code === 1) {
                        window.location.href = "{:url('merchant/index/index')}";
                    } else if (res.code === 2) {
                        window.location.href = "{:url('merchant/index/index')}";
                    } else if (res.code === 3) {
                        layer.msg(res.msg, {icon: 2, time: 1000}, function () {

                        });

                    }
                }
            });
        });
        form.on('radio(filter)', function (data) {
            //选择验证，谷歌的话先身份验证
            if (data.value == 1) {
                $('#googlecode').hide();
                $('#codeimg').hide();
                $('#mobilecode').show();
            } else {
                var username = $('#LAY-user-login-username').val();
                var password = $('#LAY-user-login-password').val();
                // var mobile = $('#LAY-user-login-mobile').val();
                if (username == '' || password == '' //|| mobile == ''
                ) {
                    layer.msg("{:lang('请输入账号密码')}", {icon: 2, time: 1000}, function () {
                        $('#LAY-user-login-password').val('');
                        $('#code1').val('');
                        $('#code2').val('');
                        $('#gg').prop('checked', false);
                        $('#sj').prop('checked', true);
                        form.render();
                    });
                } else {
                    // setMaxDigits(131);
                    // var key = new RSAKeyPair("10001", '', m);
                    // password = encryptedString(key, password);
                    $.ajax({
                        url: "{:url('user/verify')}",
                        type: 'post',
                        data: {
                            username: username,
                            password: password,
                            //mobile: mobile
                        },
                        success: function (response) {
                            if (response.code === 0) {
                                if (response.isshow === 1) {
                                    $('#imgsrc').attr('src', response.data);
                                    $('#secret').html(response.secret);
                                    $('#codeimg').show();
                                    $('#secretpart').show();
                                } else {
                                    $('#codeimg').hide();
                                    $('#secretpart').hide();
                                }
                                $('#googlecode').show();
                                $('#mobilecode').hide();
                            } else {
                                layer.msg(response.msg, {icon: 2, time: 1000}, function () {
                                    //window.location.reload();
                                    $('#LAY-user-login-password').val('');
                                    $('#code1').val('');
                                    $('#code2').val('');
                                    $('#gg').prop('checked', false);
                                    $('#sj').prop('checked', true);
                                    form.render();

                                });
                            }
                        }
                    });
                }
            }
        });


        $("#LAY-user-login-password").blur(function(){
            var username = $('#LAY-user-login-username').val();
            var password = $('#LAY-user-login-password').val();
            // var mobile = $('#LAY-user-login-mobile').val();
            if (username == '' || password == '' //|| mobile == ''
            ) {
                layer.msg("{:lang('请输入账号密码')}", {icon: 2, time: 1000}, function () {
                    $('#LAY-user-login-password').val('');
                    $('#code1').val('');
                    $('#code2').val('');
                    // $('#gg').prop('checked', false);
                    // $('#sj').prop('checked', true);
                    form.render();
                });
            } else {
                // setMaxDigits(131);
                // var key = new RSAKeyPair("10001", '', m);
                // password = encryptedString(key, password);
                $.ajax({
                    url: "{:url('user/verify')}",
                    type: 'post',
                    data: {
                        username: username,
                        password: password,
                        //mobile: mobile
                    },
                    success: function (response) {
                        if (response.code === 0) {
                            if (response.isshow === 1) {
                                $('#imgsrc').attr('src', response.data);
                                $('#secret').html(response.secret);
                                $('#codeimg').show();
                                $('#secretpart').show();
                            } else {
                                $('#codeimg').hide();
                                $('#secretpart').hide();
                            }
                            $('#googlecode').show();
                        } else {
                            layer.msg(response.msg, {icon: 2, time: 1000}, function () {
                                //window.location.reload();
                                $('#LAY-user-login-password').val('');
                                $('#code2').val('');
                                $('#codeimg').hide();
                                $('#secretpart').hide();
                                form.render();

                            });
                        }
                    }
                });
            }
        });

        //发送短信验证码
        $('#sendcode').on('click', function () {
            sendCode();
        });

        function sendCode() {
            var phoneNum = $('#LAY-user-login-mobile').val();
            if (phoneNum === '') {
                layer.msg("{:lang('手机号码不能为空')}");
                return false;
            }

            $.ajax({
                url: "{:url('user/sendSms')}",
                type: 'get',
                data: {
                    mobile: phoneNum,
                    //captcha: captcha
                },
                success: function (response) {
                    if (response.code === 0) {
                        layer.msg("{:lang('发送成功')}");
                        cache.setItem('loginCode', phoneNum);
                        cache.createTimeOut();
                    } else {
                        layer.msg(response.msg)
                    }
                }
            })
        }
    });
</script>
</body>
</html>